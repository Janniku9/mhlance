---
import { Games } from '../../../data/games';
import { getGameFromPath } from '../../../utils/game';
import type { Game } from '../../../types/Game';
import Select from '../../input/Select.astro';
import SelectOption from '../../input/SelectOption.astro';

// Get current game from URL
const currentPath = Astro.url.pathname;
const selectedGame = getGameFromPath(currentPath);

// Format game name for display
const formatGameName = (game: Game) => game.name.toUpperCase();
---

<Select transition:persist transition:name="game-select">
  <Fragment slot="selected">
    {selectedGame ? formatGameName(selectedGame) : 'SELECT GAME'}
  </Fragment>

  <SelectOption value="" selected={!selectedGame}> SELECT GAME </SelectOption>
  {
    Games.map((game) => (
      <SelectOption value={game.id} selected={selectedGame?.id === game.id}>
        {formatGameName(game)}
      </SelectOption>
    ))
  }
</Select>

<script>
  import { navigate } from 'astro:transitions/client';
  import { gameStore } from '../../../stores/GameStore';
  import type { GameType } from '../../../types/Game';

  function initializeGameSelect() {
    const handleSelectChange = (e: CustomEvent) => {
      const gameId = e.detail.value as GameType;
      const newPath = gameId ? `/${gameId}` : '/';

      console.log('Navigating to:', newPath); // Debug log
      gameStore.setGame(gameId);
      navigate(newPath);
    };

    // Remove old event listeners before adding new ones
    document.querySelectorAll('[data-custom-select]').forEach((select) => {
      select.removeEventListener('select:change', handleSelectChange as EventListener);
      select.addEventListener('select:change', handleSelectChange as EventListener);
    });
  }

  // Initialize on first load
  initializeGameSelect();

  // Handle view transitions
  document.addEventListener('astro:after-swap', initializeGameSelect);

  // Handle browser navigation
  window.addEventListener('popstate', () => {
    const pathParts = window.location.pathname.split('/');
    const gameId = pathParts[1] || null;
    gameStore.setGame(gameId as GameType);
  });
</script>
